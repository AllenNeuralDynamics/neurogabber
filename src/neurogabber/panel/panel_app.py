import os, json, httpx, panel as pn
from panel_neuroglancer import Neuroglancer

#pn.extension()

BACKEND = os.environ.get("BACKEND", "http://127.0.0.1:8000")

prompt = pn.widgets.TextAreaInput(name="Prompt", height=140,
                                  placeholder="Show me the middle, zoom to fit, hide all annotations")
run_btn = pn.widgets.Button(name="Run", button_type="primary")
status = pn.pane.Markdown("Ready.")
#viewer = Neuroglancer(source="https://aind-neuroglancer-sauujisjxq-uw.a.run.app/#!s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/raw_data.json")  # starts empty; we'll set .source to a state URL
NG_URL= "https://aind-neuroglancer-sauujisjxq-uw.a.run.app/#!%7B%22dimensions%22:%7B%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22t%22:%5B0.001%2C%22s%22%5D%7D%2C%22position%22:%5B48.5%2C-3598.5%2C584.5%2C0.5%5D%2C%22crossSectionScale%22:1%2C%22projectionScale%22:8192%2C%22layers%22:%5B%7B%22type%22:%22image%22%2C%22source%22:%5B%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0000_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0001_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0002_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0003_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0004_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0005_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0006_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0007_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0000_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0001_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0002_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0003_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0004_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0005_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0006_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0007_Z_0000_ch_405.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%5D%2C%22localDimensions%22:%7B%22c%27%22:%5B1%2C%22%22%5D%7D%2C%22localPosition%22:%5B0.5%5D%2C%22tab%22:%22source%22%2C%22opacity%22:1%2C%22blend%22:%22additive%22%2C%22shader%22:%22#uicontrol%20vec3%20color%20color%28default=%5C%22#ffffff%5C%22%29%5Cn#uicontrol%20invlerp%20normalized%5Cnvoid%20main%28%29%20%7B%5CnemitRGB%28color%20%2A%20normalized%28%29%29%3B%5Cn%7D%22%2C%22shaderControls%22:%7B%22normalized%22:%7B%22range%22:%5B90%2C1200%5D%7D%7D%2C%22name%22:%22CH_405%22%7D%2C%7B%22type%22:%22image%22%2C%22source%22:%5B%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0000_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0001_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0002_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0003_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0004_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0005_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0006_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0000_Y_0007_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C-912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0000_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0001_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0002_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0003_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C-912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0004_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C912%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0005_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C2735%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0006_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C4559%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%2C%7B%22url%22:%22zarr://s3://aind-open-data/HCR_794300-10_2025-08-14_13-00-00/SPIM.ome.zarr/Tile_X_0001_Y_0007_Z_0000_ch_638.zarr%22%2C%22transform%22:%7B%22matrix%22:%5B%5B1%2C0%2C0%2C0%2C0%2C0%5D%2C%5B0%2C1%2C0%2C0%2C0%2C0%5D%2C%5B0%2C0%2C1%2C0%2C0%2C0%5D%2C%5B0%2C0%2C0%2C1%2C0%2C6384%5D%2C%5B0%2C0%2C0%2C0%2C1%2C912%5D%5D%2C%22outputDimensions%22:%7B%22t%22:%5B0.001%2C%22s%22%5D%2C%22c%27%22:%5B1%2C%22%22%5D%2C%22z%22:%5B0.000001%2C%22m%22%5D%2C%22y%22:%5B2.4505557964997545e-7%2C%22m%22%5D%2C%22x%22:%5B2.4505557964997545e-7%2C%22m%22%5D%7D%7D%7D%5D%2C%22localDimensions%22:%7B%22c%27%22:%5B1%2C%22%22%5D%7D%2C%22localPosition%22:%5B0.5%5D%2C%22tab%22:%22source%22%2C%22opacity%22:1%2C%22blend%22:%22additive%22%2C%22shader%22:%22#uicontrol%20vec3%20color%20color%28default=%5C%22#ff00ff%5C%22%29%5Cn#uicontrol%20invlerp%20normalized%5Cnvoid%20main%28%29%20%7B%5CnemitRGB%28color%20%2A%20normalized%28%29%29%3B%5Cn%7D%22%2C%22shaderControls%22:%7B%22normalized%22:%7B%22range%22:%5B90%2C1200%5D%7D%7D%2C%22name%22:%22CH_638%22%7D%5D%2C%22showAxisLines%22:false%2C%22showScaleBar%22:false%2C%22layout%22:%224panel%22%7D" \
viewer = Neuroglancer(source=NG_URL)

async def run(_):
    status.object = "Running…"
    async with httpx.AsyncClient(timeout=60) as client:
        # 1) Ask the agent for tool calls
        chat = {"messages": [{"role":"user","content": prompt.value}]}
        resp = await client.post(f"{BACKEND}/agent/chat", json=chat)
        data = resp.json()
        # 2) Execute any tool calls
        for choice in data.get("choices", []):
            msg = choice.get("message", {})
            for tc in msg.get("tool_calls", []):
                name = tc["function"]["name"]
                args = json.loads(tc["function"]["arguments"] or "{}")
                await client.post(f"{BACKEND}/tools/{name}", json=args)
        # 3) Save state and open the URL in the embedded NG widget
        save = await client.post(f"{BACKEND}/tools/state.save", json={})
        url = save.json()["url"]
        viewer.source = url
        status.object = f"**Opened:** {url}"

run_btn.on_click(lambda e: pn.state.run_async(run(e)))

app = pn.Column(
    pn.pane.Markdown("# Neurogabber (Panel prototype)"),
    prompt, run_btn, status, viewer,
    sizing_mode="stretch_width",
)
app.servable()